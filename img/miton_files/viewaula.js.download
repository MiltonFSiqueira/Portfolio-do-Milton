var header;
var lastScrollTop;
var topScrollLimit;
var topScrollOffset = 200;
var devslider;

function updatePageElements(top){

    $(".header-container").css("top", top + "px");

    let altura_barra_principal = $(".header-container").height();

    let offset_top_menu_lateral = altura_barra_principal + top;

    let header_site_devmedia = $(".header-site-devmedia");
    let offset_top_header_site = header_site_devmedia[0].offsetTop;
    let altura_header_site = header_site_devmedia[0].clientHeight;

    let offsetTop_menu = altura_header_site + offset_top_header_site;

    /* MENU LATERAL EXEMPLO */
    let altura_topo = header[0].clientHeight;
	let ofssetTop_topo = header[0].offsetTop;

	let calc_topo = altura_topo + ofssetTop_topo;

	let altura_navbar = $(".header-container").height();
    let nova_altura = altura_navbar + calc_topo;

    if( $(window).innerWidth() < 1024 ){

        $(".side-menu-container").css("top", offsetTop_menu + "px");

        header = $(".header-site-devmedia");

        altura_topo = header[0].clientHeight;
        ofssetTop_topo = header[0].offsetTop;
        
        nova_altura = altura_navbar + calc_topo;

        nova_altura = nova_altura + (nova_altura - top);

    } else {

        $(".side-menu-container").css("top", offset_top_menu_lateral + "px");

    }

	$("#menu-aula").css("top", nova_altura);
    $("#menu-anotacao").css("top", nova_altura);
    
    let novoTamanhoAnotacao = window.innerHeight - nova_altura;
	$("#menu-anotacao").css("height", novoTamanhoAnotacao);
}

function verificarParametroAnotacao() {
    let url     = $(location).attr('href');
    let index   = url.indexOf('anotacoes=1');

    if(index != -1) {
        $('.menu-acoes-btn.menu-btn-anotacao').trigger("click");  
    }
}

$(document).ready(function(){
    
    prism();
    header = $(".header-site-devmedia");
    lastScrollTop = topScrollLimit = $(window).scrollTop();

    var isMobile = false;
    if (typeof window.orientation !== 'undefined'){
        isMobile = true;
    }

    var modalCloseBtn = $(".dev-modal-close");
    if(modalCloseBtn.length > 0){
        $(".devbot-wrapper").append(modalCloseBtn);
    }

    $("body").on("click", ".dev-modal.active, .dev-modal.active .dev-modal-close", function(){
        fecharModal();
    });

    $("body").on("click", ".dev-modal-body", function(e){
        e.stopPropagation();
    });

    function AjustarMenus(){
        let header = $(".header-site-devmedia");

        let altura_topo = header[0].clientHeight;

        let ofssetTop_topo = header[0].offsetTop;

        //let altura_navbar = $(".top-header-size ").height();
        let calc_topo = altura_topo + ofssetTop_topo;

        let altura_menu_aula = calc_topo;

        if( $(window).innerWidth() < 1024 ){

            let header_site_devmedia = $(".header-site-devmedia");
            let offset_top_header_site = header_site_devmedia[0].offsetTop;
            let altura_header_site = header_site_devmedia[0].clientHeight;

            let offsetTop_menu = altura_header_site + offset_top_header_site;

            $(".side-menu-container").css("top", offsetTop_menu + "px");

            let top = header[0].clientHeight + header[0].offsetTop;

            altura_menu_aula = altura_menu_aula + (altura_menu_aula - top);
        }
        $("#menu-aula, #menu-anotacao").css("top", altura_menu_aula);

        if(altura_menu_aula < altura_topo){
            $(".lista-aulas").addClass("topo-fechado");
        }else{
            $(".lista-aulas").removeClass("topo-fechado");
        }

    } 

    $(window).on("resize scroll", function(){
        AjustarMenus();
    });

    /* BEGIN Video */
        var isfullscreen = false;
        var videoLength = 0;
        var seeking = false;
        var wasPlaying = false;
        var seekingPosition = 0;

        var videoTimeout = null;

        var hoverControls = false;
        var hoverApoioButton = false;
        var hoverTimeout = null;

        var watchedTime = 0;
        var watchedPercent = 0;
        var watchedPercentTimeout = null;

        var autoMarcado = false;
        currentVideo(autoMarcado)

        function videoRefreshProgress(){
            currentTimeLabel.text(secondsToMinutes(videoDOM.currentTime));
            var currentTimePercent = videoDOM.currentTime * 100 / videoLength;
            renderProgress(currentTimePercent);
        }

        function renderProgress(percent){
            var currentWidth =  $(currentBar).width();
            var newScale = ((currentWidth / 100) * percent) / currentWidth;
            
            if(newScale > 1){
                newScale = 1;
            }else if(newScale < 0){
                newScale = 0;
            }

            currentBar.css("transform", "scaleX("+ newScale + ")");

            var agulhaMin = (8 * 100) / currentWidth;
            var agulhaMax = (currentWidth - 8) * 100 / currentWidth;

            agulhaPercent = percent;
            if(agulhaPercent < agulhaMin){
                agulhaPercent = agulhaMin;
            }else if(agulhaPercent > agulhaMax){
                agulhaPercent = agulhaMax;
            }

            videoAgulha.css("left", "calc(" + agulhaPercent + "% - 8px )");

            //menu aulas
            var menuAulaScale = 0;

            if(videoDOM.currentSrc.indexOf("vinheta") == -1){
                menuAulaScale = newScale;
            }
            $("#menu-aula .curso-aula.active .curso-aula-progresso-current").css("transform", "scaleX("+ menuAulaScale + ")");
        }

        function secondsToMinutes(s){
            if(isNaN(s)){
                return "0:00";
            }
            var minutos = Math.floor(s / 60);
            var seconds = Math.floor(s - minutos * 60);
            return minutos + ":" + (seconds > 9? seconds: "0"+seconds);
        }
    /* END Video */
    
    /* BEGIN VIEWAULA */        
        if(window.innerWidth > 768){
            menuAberto = !$("#viewaula").hasClass("menu-aula-fechado");
        }else{
            menuAberto = false;
        }
        
        anotacaoAberto = false;
        var anotacao = $(".anotacao-conteudo textarea[name=anotacao]");
        var anotacaoMaxHeight = 0;
        var lastAnotacao = anotacao.val();
        var lastSave = lastAnotacao;

        function resizeAnotacoes(){
            var ofs = window.innerWidth > 768 ? 25 : 65;
            anotacaoMaxHeight = (window.innerHeight -  $(".anotacao-conteudo")[0].getBoundingClientRect().top) - ofs;
            $(".anotacao-conteudo").css("max-height",anotacaoMaxHeight);

            var st = 0;
            if(document.getSelection().anchorNode != null){
                st = document.getSelection().anchorNode.scrollTop;
            }
            
            anotacao.height("");
            var newSH = anotacao[0].scrollHeight + 40; // > anotacaoMaxHeight? anotacaoMaxHeight : anotacao[0].scrollHeight;
            anotacao.height(newSH);

            $(".anotacao-conteudo").scrollTop(st);
        }

        $(".aula-sessao-navs a").on("click", function(e){
            e.preventDefault();

            var id = $(this).attr("href");
            var aba = $(id);
            if(aba.length > 0){
                if(!$(this).hasClass("active") && !aba.hasClass("active")){
                    $(".aula-sessao-navs a.active").removeClass("active");
                    $(".aula-sessao-conteudo.active").removeClass("active");

                    $(this).addClass("active");
                    aba.addClass("active");

                    scrollToPosition(0, 400);
                }
            }
        });

        $(".video-content .close-mini-video").on("click", function(){
            $(".video-content").removeClass("fixed").addClass("unfixed");
        });

        $(".menu-aula-float-button").on("click", function(){
            openMenu();
        });
        
        $(".menu-aula-button-close").on("click", function(){
            closeMenu();
        });

        $(".menu-acoes-btn.menu-btn-submenu").on("click", function(){
            toggleMenu();
        });

        /* $("#viewaula:before").on("click", function(){
            closeMenu();
        }); */

        $(".btn-conteudo-apoio").on("click", function(){
            var contentPosition = window.innerHeight - 75 + 2;
            scrollToPosition(contentPosition, 300);
        });

        $(window).resize(function(){
            resizeAnotacoes();
            if(typeof player != "undefined" && player != null){
                player.resizer.setVideoSize();
            }
        });

        if (typeof $.fn.menuFixer != "undefined"){
            let top = $(".aula-sessoes").children().first().offset().top;
            let topDocument = $("#aula-conteudo").offset().top;
            $(".menu-acoes-container").css("top", top - 20);
            $(".menu-acoes-container").menuFixer(topDocument, $(".main-footer"));
        }

        $(".curso-navegacao-button.disabled").click(function(e){
            e.preventDefault();
        });

        var lastScroll = showHideTabs();

        var lastScrollTop = 0;
        var last_direction = 1; // 0 - down | 1 - up
        
        $(window).on("hashchange", function(e){
            // lugar editado
            if(window.innerWidth <= 768 && location.hash != "#menu-aberto"){
                closeMenu();
                closeMenuAnotacao();
            }
        });

        function showHideTabs(){
            var newScroll = $(window).scrollTop();
            if(newScroll == 0){
                $(".aula-sessao-navs").removeClass("scroll-hide");
            }else{
                var dir = lastScroll - newScroll;

                if(dir < 0){ // cima
                    $(".aula-sessao-navs").addClass("scroll-hide");
                }else{ // baixo
                    $(".aula-sessao-navs").removeClass("scroll-hide");
                }
            }

            return newScroll;
        }

        function toggleMenu(){
            if($("#viewaula").hasClass("menu-aula-fechado") || $("#viewaula").hasClass("menu-mobile-fechado")){
                openMenu();
            }else{
                closeMenu();
            }
        }

        function openMenu(){
            closeMenuAnotacao();
            $("#viewaula").removeClass("menu-aula-fechado");
            $("#viewaula").removeClass("menu-mobile-fechado");
            $(".main-footer").removeClass("menu-aula-fechado-footer");
            $("body").addClass("mobile");
            fixScreen();
            location.hash = "menu-aberto";
            menuAberto = true;

            if(typeof player != "undefined" &&  player != null){
                $("#aula-conteudo").on('transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd', function() {
                    player.resizer.setVideoSize();
                });
            }
        }

        function closeMenu(){
            $("#viewaula").addClass("menu-aula-fechado");
            $(".main-footer").addClass("menu-aula-fechado-footer");
            $("body").removeClass("mobile");
            unfixScreen();
            if(location.hash == "#menu-aberto")
                history.replaceState("", document.title, window.location.href.replace(window.location.hash, ""))

            menuAberto = false;
        }

        function toggleMenuAnotacao(){

            if($("#viewaula").hasClass("menu-anotacao-aberto")){
                closeMenuAnotacao();
            }else{
                openMenuAnotacao();
            }
        }

        function closeMenuAnotacao(){

            editarAnotacaoBackground();
            $("#viewaula").removeClass("menu-anotacao-aberto");
            $(".main-footer").removeClass("menu-anotacao-aberto-footer");
            $("body").removeClass("mobile");
            unfixScreen();
            if(location.hash == "#menu-aberto")
                history.replaceState("", document.title, window.location.href.replace(window.location.hash, ""))

            anotacaoAberto = false;
        }
        
        function openMenuAnotacao(){
            if($("#menu-anotacao").attr("off") == undefined){
                closeMenu();
                $("#viewaula").addClass("menu-anotacao-aberto");
                $(".main-footer").addClass("menu-anotacao-aberto-footer");
                $("body").addClass("mobile");
                fixScreen();
                location.hash = "menu-aberto";

                anotacaoAberto = true;

                if(typeof player != "undefined" && player != null){
                    $("#menu-anotacao").on('transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd', function() {
                        player.resizer.setVideoSize();
                    });
                }
            }else{
                abrirModal("Voc&ecirc; precisa estar logado para realizar essa a&ccedil;&atilde;o. <br> <a target='_blank' href='//www.devmedia.com.br/login/login.asp'>Clique aqui para logar.</a>", true);
            }
        }

        var telaFixa = false;
        
        function fixScreen(){
            if(!telaFixa){
                $("body").css("top", ($(window).scrollTop() * -1) + "px");
                $("body").addClass("fixScreen");
                telaFixa = true;
            }
        }

        function unfixScreen(){
            if(telaFixa){
                var top = $("body").offset().top * -1;
                $("body").removeClass("fixScreen");
                $(window).scrollTop(top);
                telaFixa = false;
            }
        }

        //#viewaula:not(.contentPosition):not(.videoHover)

    /* END VIEWAULA */

    /* BEGIN MENU_ACAO */
        $(document).on("click", ".menu-acoes-btn.menu-btn-comentario", function(e){
            e.preventDefault();

            if(window.innerWidth <= 768){
                closeMenu();
            }
            scrollToPosition($(".comentarios-area").offset().top - 85, 600);
        });

        $(document).on("click", ".menu-acoes-btn.menu-btn-anotacao",function(e){
            e.preventDefault();

            toggleMenuAnotacao();
        });

        $(".menu-anotacao-button-close").on("click", function(e){
            closeMenuAnotacao();
        });

        $(".menu-acoes-btn.menu-btn-favoritar").on("click", function(e){
            e.preventDefault();

            var id = info["id_comp_aula"];
            $(".dev-modal-title").html("Favorito");
            obterModal("favorito", id, null, null, function(){
                $(".menu-acoes-btn.menu-btn-favoritar").addClass("active");
            });
        });

        $(".menu-acoes-btn.menu-btn-curtir").on("click", function(e){
            e.preventDefault();

            var id = $(this).data("id");
            $(".dev-modal-title").html("Curtir");
            obterModal("avaliarUtil", id, 1, null, function(x){
                
                var total_likes = $("#menu-acoes-footer .menu-btn-like-count").text();

                total_likes = parseInt(total_likes) + 1;

                $(".menu-btn-like-count").html(total_likes);

                $(".menu-acoes-btn.menu-btn-curtir").addClass("active");
            });

        });
        
        $(document).on("click", ".menu-acoes-btn.menu-btn-concluido", function(e){
            e.preventDefault();

            var ultima = $(this).data("ultima") == true? true: false;
            var exercicio = $(this).data("exercicio") == true? true: false;

            var id = info["id_comp_aula"] 
            $(".dev-modal-title").html("Concluído");
            obterModal("concluido", id, null, null, function(){
                $(".menu-acoes-btn.menu-btn-concluido").addClass("active");
                exibirMarcarConcluido();
            }, ultima, exercicio);
        
        });

        $(document).on("click", ".menu-btn-download",function(e){
            var id = $(this).data("id");
            $(".dev-modal-title").html("Download da Vídeo Aula");
            obterDownload("donwload", id);
        });

        $(document).on("click",".menu-btn-fonte", function(e){
            var id = $(this).data("id");
            $(".dev-modal-title").html("Download do Código Fonte");
            if($(this).attr("curso") != undefined){
                obterDownload("fontes", id, true);
            }else{
                obterDownload("fontes", id);
            }
        });

        $(".menu-acoes-btn.menu-btn-like").on("click", function(e){
            e.preventDefault();

            var id = $(this).data("id");
            $(".dev-modal-title").html("Avaliação");
            obterModal("avaliarUtil", id, 1, null, function(x){
                if(x > 0){
                    $(".menu-acoes-btn.menu-btn-like .menu-btn-like-count").html(x);
                    $(".menu-acoes-btn.menu-btn-like .menu-btn-like-count").removeClass("like-qnt-hidden");
                }else if(x != null){
                    $(".menu-acoes-btn.menu-btn-like .menu-btn-like-count").addClass("like-qnt-hidden");
                }

                $(".menu-acoes-btn.menu-btn-like").addClass("active");
            });
        });

        $(".menu-acoes-btn.menu-btn-dislike").on("click", function(e){
            var id = $(this).data("id");
            $(".dev-modal-title").html("Avaliação");
            obterModal("avaliarUtilNegativo", id, -1, null, function(x){
                var form = $(".dev-modal-conteudo form[name='form_voto_negativo']");
                var formBtn = $(".dev-modal-conteudo form[name='form_voto_negativo'] .btn-confirm");
                formBtn.on("click", function(e){
                    e.preventDefault();
                    var dados = form.serialize()+'&'+$.param({ "funcao": "salvarAvaliarUtilNegativo" });
                    
                    fecharModal();

                    $.ajax({
                        url: "//www.devmedia.com.br/view/scripts/valida.php",
                        method: "POST",
                        data: dados,
                        success: function(response){
                            abrirModal(response.html , true);
                            if(response.status){
                                if(response.return != undefined){
                                    if(response.return > 0){
                                        $(".menu-btn-dislike .menu-btn-like-count").text(response.return);
                                        $(".menu-btn-dislike .menu-btn-like-count").removeClass("like-qnt-hidden");
                                        $(".menu-acoes-btn.menu-btn-dislike").addClass("active");
                                        $(".menu-acoes-btn.menu-btn-like").removeClass("active");
                                    }
                                }
                            }
                        },
                        error: function(response){
                            console.log(response.html, true);
                            abrirModal("Ocorreu um erro", true);
                        }
                    });
                    return false;
                });
            });
        });

        $(".menu-acoes-btn.compartilhar").on("click", function(e){
            $(".container-modal-share").removeClass("hide");
        });

        $(document).on("click", ".close-button", function () {
            $(".container-modal-share").addClass("hide");
        });

        $(document).on("click",".indique-copy-btn", function (e) {
            e.preventDefault();
            let btn_copy = $(this);
            let link = btn_copy.siblings(".input-link")[0];
            link.select();
            document.execCommand("copy");
            btn_copy.html("Copiado");
            btn_copy.addClass("copiado");
        });

        $(".curso-avaliacao-star").on("click", function(e){
            var conteudo = $(this).data("value");
            var id = $(".curso-avaliacao").data("id");
            $(".dev-modal-title").html("Avaliação");
            obterModal("avaliarConteudo", id, null, conteudo, function(x){
                $(".curso-avaliacao").addClass("votado");
                $(".curso-avaliacao .curso-avaliacao-star").removeClass("active");
                $(".curso-avaliacao .curso-avaliacao-star[data-value='" + x + "']").addClass("active");
            });
        });

        $(".menu-anotacao-icone-editar").on("click", function(e){
            var conteudo = $(".anotacao-conteudo textarea[name=anotacao]").val();
            var comp = info["id_comp_aula"];
            $(".dev-modal-title").html("Anotação");

            obterModalAnotacao("salvarAnotacao", comp, null, conteudo, true, function(x){
                if(x == 0){
                    $(".anotacao-area, .menu-btn-anotacao").removeClass("active");
                }else{
                    $(".anotacao-area, .menu-btn-anotacao").addClass("active");
                }
                
            });
        });

        function editarAnotacaoBackground(){
            var conteudo = $(".anotacao-conteudo textarea[name=anotacao]").val();
            var comp = info["id_comp_aula"];
            $(".dev-modal-title").html("Anotação");

            obterModalAnotacao("salvarAnotacao", comp, null, conteudo, true, function(x){
                if(x == 0){
                    $(".anotacao-area, .menu-btn-anotacao").removeClass("active");
                }else{
                    $(".anotacao-area, .menu-btn-anotacao").addClass("active");
                }
                
            });
        }

        function obterDownload(funcao, comp, curso){
            if(curso == undefined || curso == null){
                curso = false;
            }
            $.ajax({
                url: "//www.devmedia.com.br/view/scripts/valida.php",
                method: "POST",
                data: { "funcao": funcao, "comp": comp, "curso": curso},
                success: function(response){
                    if(response.status){
                        var link = document.createElement("a");
                        var url = response.html.replace("http://", "https://");

                        if(!response.html.includes("https://")){
                            if(response.html.includes("//")){
                                url = "https:"+url;
                            }else{
                                url = "https://"+url;
                            }
                        }

                        link.href = url;
                        link.target = "_blank";

                        if(curso){
                            tituloDownload = "Codigo-fonte-completo-"+$(".label-titulo-curso").text();
                        }else{
                            tituloDownload = $(".label-titulo-curso").text()+"-Aula-"+$(".curso-aula.active .curso-aula-titulo").text();
                        }

                        regexCaracteresEspeciais = /[\.\(\)\:]/g;
                        regexEspaco = /\s/g;

                        tituloDownload = tituloDownload.replaceAll(regexCaracteresEspeciais, "");
                        tituloDownload = tituloDownload.replaceAll(regexEspaco, "-");

                        link.download = "";//tituloDownload;

                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        delete link;

                        //window.open(response.html , '_blank');
                    }else{
                        abrirModal(response.html , true);
                    }
                },
                error: function(response){
                    console.log(response, true);
                    abrirModal("Ocorreu um erro", true);
                }
            });
        }

        function obterModal(funcao, comp, util, conteudo, callback, ultima, exercicio){
            if (util == undefined) util = null;
            if (conteudo == undefined) conteudo = null;
            if (callback == undefined) callback = null;
            if (ultima == undefined) ultima = false;
            if (exercicio == undefined) exercicio = false;

            $.ajax({
                url: "//www.devmedia.com.br/view/scripts/valida.php",
                method: "POST",
                data: { "funcao": funcao, "comp": comp, "util": util, "conteudo": conteudo, "ultima": ultima, "exercicio": exercicio},
                success: function(response){
                    if(typeof response.exibir != "undefined" && response.exibir == true){
                        abrirModal(response.html , true);
                    }

                    if(response.status){
                        if(response.return != undefined){
                            
                            callback(response.return);

                            if( $(response.pontos_temporada).length > 0 ){

                                let pontos_temporada = response.pontos_temporada;
                                let limite_pontos_temporada = response.limite_pontos_temporada;
                                let pontos_bonus = response.bonus_ponto;
                                let bonus_obtido = response.bonus_obtido;

                                let cookie_fa = document.cookie.indexOf('fa=');

                                if ( pontos_temporada >= limite_pontos_temporada && pontos_bonus == 1 && cookie_fa == -1 && bonus_obtido == 0 ){

                                    /*let date = new Date();
                                    let day = date.getDay();
                                    let month = date.getMonth();
                                    let year = date.getFullYear();

                                    new_date = new Date(year, month + 1, 1);
                                    date_expires = new Date(new_date - 1); */

                                    /* let timestamp_expire = date_expires.getTime();

                                    timestamp_expire += 10800000; */

                                    // let cookie_expiration = new Date(timestamp_expire);

                                    // document.cookie = "fa=1; expires=" + cookie_expiration + ";path=/";

                                    let date_expires = new Date() -1;
                                    let cookie_expiration = new Date(date_expires);
                                    document.cookie = "FA=1; expires=" + cookie_expiration + ";path=/";

                                    location.href = "https://www.devmedia.com.br/";
                                }

                            }

                        }else{
                            callback();
                        }
                    }
                },
                error: function(response){
                    console.log(response, true);
                    abrirModal("Ocorreu um erro", true);
                }
            });
        }

        function obterModalAnotacao(funcao, comp, id , anotacao, modal, callback){
            if (id == undefined) id = null;
            if (anotacao == undefined) anotacao = null;
            if (callback == undefined) callback = null;

            if(lastSave != anotacao){
                $.ajax({
                    url: "//www.devmedia.com.br/view/scripts/valida.php",
                    method: "POST",
                    data: { "funcao": funcao, "comp": comp, "id": id, "anotacao": anotacao},
                    success: function(response){
                        if(response.status){
                            if(modal === true){
                                if(response.exibir){
                                    abrirModal(response.html , true);
                                }
                            }
                            if(response.return != undefined){
                                callback(response.return);
                            }else{
                                callback();
                            }

                            lastSave = anotacao;
                        }else{
                            if(response.exibir){
                                abrirModal(response.html , true);
                            }
                        }
                    },
                    error: function(response){
                        console.log(response, true);
                        abrirModal("Ocorreu um erro", true);
                    }
                });
            }
        }

        function abrirModal(conteudo, option){
            //devbot.setMessage(conteudo);
            $(".dev-modal .devbot-dialog").html(conteudo);

            $(".dev-modal").addClass("active");
            fixScreen();
        }

        function fecharModal(){
            $(".dev-modal").removeClass("active");            
            if(!$("body").hasClass("mobile")){
                unfixScreen(); 
            }
        }
    /* END MENU_ACAO */

    /* BEGIN ANOTACAO */
        resizeAnotacoes();
        anotacao.on("keyup scroll", function(e){
            if(lastAnotacao != anotacao.val()){
                resizeAnotacoes();
                lastAnotacao = anotacao.val();
            }
        });
    /* END ANOTACAO */

    /* BEGIN MODAL */
        $(".dev-modal-close, .dev-modal-bg").on("click", function(e){
            fecharModal();
        });

        $(".dev-modal").on("click", function(e){
            e.stopPropagation();
        });
    /* END MODAL */

    /* BEGIN PROXIMA AULA MODAL MARCAR CONCLUIDO */
        $(document).on('click', '.curso-aula, .curso-navegacao-button.proximo', function(e) {
            e.preventDefault();

            if(window.innerWidth <= 768){
	           closeMenu();
            }
            
            var idcomp_atual = info["id_comp_aula"];
            var idcomp_proximo = $(this).attr('data-idcomp');
            var url_exercicio = $(this).attr("href");
            
            $(".menu-btn-concluido").attr('data-id',info["id_comp_aula"]);

            if($(this).data("exercicio")){
                $.ajax({
                    url: '//www.devmedia.com.br/inc/cursos/controller/curso_controller.php',
                    type: 'POST',
                    data: {funcao: 'finalizou_aula', idcomp: idcomp_atual},
                })
                .done(function(data) {
                    window.location.href = url_exercicio;                    
                })
                .fail(function() {
                    console.log("error");
                }); 
            } else {           
                if(info["concluido"] == false){
                    $(".modal-concluir-aula").toggleClass('show-concluir-aula');            
                    $('#aula-finalizada').data('finalizar', idcomp_atual);
                    $('#aula-finalizada').data('proxima_aula', idcomp_proximo);
                    $('#aula-emandamento').data('proxima_aula', idcomp_proximo);
                } else {
                    trocaAula(idcomp_proximo)
                }
            }
            
        });

        $(document).on('click', '.modal-close-concluir-aula', function(e) {
            $(".modal-concluir-aula").toggleClass('show-concluir-aula');
        });

        $(document).on('click', '#aula-emandamento', function(e) {
            var exercicio = $(this).data("exercicio") == true? true: false;
            var link = $(this).data('link');
            var idcomp_proximo = $(this).data('proxima_aula');
            $(".modal-concluir-aula").toggleClass('show-concluir-aula');  

            if(exercicio == true){
                window.location.href = link;
            }else{
                trocaAula(idcomp_proximo)
            }
        });

        $(document).on('click', '#aula-finalizada', function(e) {
            var exercicio = $(this).data("exercicio") == true? true: false;
            var link = $(this).data('link');

            var idcomp_atual = $(this).data('finalizar');
            var idcomp_proximo = $(this).data('proxima_aula');
            var ultimaAula = $(this).data("ultima") == true? true : null;
            $(".modal-concluir-aula").toggleClass('show-concluir-aula');

            $.ajax({
                url: "//www.devmedia.com.br/view/scripts/valida.php",
                method: "POST",
                data: { "funcao": "concluido", "comp": idcomp_atual, "ultima": ultimaAula},
                success: function(response){
                    if(response.status){                   
                        if(exercicio == true){                            
                            window.location.href = link;
                        }else{
                            if (response.curso_concluido) {
                                exibirMarcarConcluido();
                                abrirModal(response.html , true);
                            } else {
                                exibirMarcarConcluido();
                                trocaAula(idcomp_proximo)
                            }
                        }
                    }else{
                        console.log(response.html);
                    }
                },
                error: function(response){
                    console.log(response, true);
                }
            });
        });

        $(".dev-modal-body").on('click', '#btn-marcar-todas', function(e){
            e.preventDefault();
            var id_curso = $(this).data("id");
            var icone = "<div class='curso-aula-progresso-completo-icon'><svg class='svg-symbol' id='svg-checked'><path id='Path_1130' class='st0' d='M21.5,14.1L17,21l-3.5-4'></path></svg></div>";

            var url_exercicio = null;
            if(($(".curso-aula.exercicio").length) > 0){
                url_exercicio = $(".curso-aula.exercicio").attr("href");
            }

            fecharModal();
            $.ajax({
                url: "//www.devmedia.com.br/view/scripts/valida.php",
                method: "POST",
                data: { "funcao": "concluidoTodos", "id": id_curso, "url_exercicio": url_exercicio},
                success: function(response){
                    $(".modal-concluir-aula").removeClass('show-concluir-aula');

                    if(response.status){
                        if (response.curso_concluido) {
                            $(".curso-aula").not(".exercicio").addClass("concluido");
                            $(".curso-aula").not(".exercicio").each(function(i, e){
                                if($(this).find(".curso-aula-progresso-completo-icon").length == 0){
                                    $(this).find(".curso-aula-progresso").not(".exercicio").append(icone);
                                }
                            });
                            abrirModal(response.html , true);
                        }
                    }else{
                        console.log(response.html);
                    }
                },
                error: function(response){
                    console.log(response, true);
                }
            });
        });
    /* BEGIN PROXIMA AULA MODAL MARCAR CONCLUIDO */

    /* BEGIN UTIL */
        function isOnScreen(element, offsetTop, offsetBottom) {
            if(offsetTop == undefined || offsetTop == null) offsetTop = 0;
            if(offsetBottom == undefined || offsetBottom == null) offsetBottom = 0;

            var win = $(window);
            var screenTop = win.scrollTop() + offsetTop;
            var screenBottom = screenTop + win.height() + offsetBottom;

            var elementTop = element.offset().top;
            var elementBottom = elementTop + element.height();

            var vertical = elementBottom > screenTop && elementTop < screenBottom;

            var screenLeft = win.scrollLeft();
            var screenRight = screenLeft + win.width();

            var elementLeft = element.offset().left;
            var elementRight = elementLeft + element.width();

            var horizontal = elementRight > screenLeft && elementLeft < screenRight;

            return vertical && horizontal;
		}

        function scrollToPosition(position, speed, transitar){
            if(transitar == undefined || transitar == null) transitar = true;
            
            var alturaTela = window.innerHeight - 75;
            var podeTransitar = ($(window).scrollTop() > alturaTela && position < alturaTela) ||
                                ($(window).scrollTop() < alturaTela && position > alturaTela);

            if($(window).scrollTop() != position){
                if(transitar && podeTransitar){
                    $("#viewaula").addClass("transitando");
                }
                $("body, html").clearQueue();
                $("body, html").animate({
                    scrollTop: position
                }, speed, function() {
                    canScroll = true;
                    $("#viewaula").removeClass("transitando");
                });
            }else{
                canScroll = true;
            }
        }

        document.addEventListener('touchstart', handleTouchStart, false);        
        document.addEventListener('touchmove', handleTouchMove, false);
        document.addEventListener('touchend', handleTouchEnd, false);
        
        var xDown = null;                                                        
        var yDown = null;
        var touchProgressBar = false;
        var touchVolumeBar = false;                                            
        
        function handleTouchStart(evt) {                                         
            xDown = evt.touches[0].clientX;                                      
            yDown = evt.touches[0].clientY;
            if(evt.target.className == "progressBar-bg"){
                progressBarClick(xDown);
                touchProgressBar = true;
                touchVolumeBar = false;
            }else if(evt.target.className == "volume-agulha" || evt.target.className == "volume-agulha"){
                volumeClick(xDown, evt.target);
                touchVolumeBar = true;
                touchProgressBar = false;
            }else{

            }
        };                                                
        
        function handleTouchMove(evt) {
            if ( ! xDown || ! yDown ) {
                return;
            }
        
            var xUp = evt.touches[0].clientX;                                    
            var yUp = evt.touches[0].clientY;

            if(touchProgressBar){
                progressBarMove(xUp);
            }else if(touchVolumeBar){
                volumeMove(xUp);
            }else{
                var xDiff = xDown - xUp;
                var yDiff = yDown - yUp;
            
                if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
                    if ( xDiff > 0 ) {
                        if(xDown > window.innerWidth - 40 && !menuAberto){
                            openMenuAnotacao();
                        }else{
                            closeMenu();
                        }
                    } else {
                        if(xDown < 40 && !anotacaoAberto){
                            openMenu();
                        }else{
                            closeMenuAnotacao();
                        }
                    }                       
                } else {
                    if ( yDiff > 0 ) {
                        /* up swipe */ 
                    } else { 
                        /* down swipe */
                    }                                                                 
                }
                /* reset values */
                xDown = null;
                yDown = null;                                             
            }
        
        };

        function handleTouchEnd(evt){
            if(touchProgressBar){
                progressBarRelease();
            }

            if(touchVolumeBar){
                volumeRelease();
            }

            touchProgressBar = false;
            touchVolumeBar = false;

            xDown = null;
            yDown = null;
        }
    /* END UTIL */

    iniciarDevslider()

    var pulseStarted = false;

    function pulseButtons(){
        if(!pulseStarted && $(".btn-ir-cod-font").length > 0){
            if(isOnScreen($(".btn-ir-cod-font"))){
                $(".btn-ir-cod-font").addClass("pulse");
                pulseStarted = true;  
            }
        }
    }

    $(window).on("scroll", function(){
        pulseButtons();
    });
    
    pulseButtons();

    $(window).trigger("resize");

    verificarParametroAnotacao();
});

function verificarParametroAnotacao() {
    let url     = $(location).attr('href');
    let index   = url.indexOf('anotacoes=1');

    if(index != -1) {
        $('.menu-acoes-btn.menu-btn-anotacao').trigger("click");  
    }
}
function exibirMarcarConcluido(automatico){
    if(automatico !== true){
        automatico = false;
    }

    $(".menu-acoes-btn.menu-btn-concluido").addClass("active");
    var icone = "<div class='curso-aula-progresso-completo-icon'><svg class='svg-symbol' id='svg-checked'><path id='Path_1130' class='st0' d='M21.5,14.1L17,21l-3.5-4'></path></svg></div>";
    var aulaAtiva = $(".curso-aula.active");
    if(aulaAtiva.find(".curso-aula-progresso-completo-icon").length == 0){
        aulaAtiva.find(".curso-aula-progresso").append(icone);
    }

    aulaAtiva.addClass("concluido");
    if(automatico){
        $(".menu-acoes-btn.menu-btn-concluido").addClass("auto");
    }
    info["concluido"] = true;
}
function iniciarDevslider(){
    if($("#devslider").length > 0){
        function runSlider() {	
            var sliderTags = $.find("[id='slide-comp']");
            $(sliderTags).each(function(i,e){
                $(e).addClass("slider-box");
            });
            
            devslider = new DevSlider(".slider-box");
        }

        if(typeof DevSlider == "undefined"){	
            $("#devslider")[0].onload = runSlider;
        }else{	
            runSlider();
        }
    }
}

function currentVideo(autoMarcado){
    if(typeof player != "undefined" && player != null){
        player.resizer.setVideoSize();
        player.rootElement.addEventListener("videoProgress", function(e){
            if(e.value >= 80 && !autoMarcado){
                autoMarcado = true;
                let id = $(".menu-acoes-btn.menu-btn-concluido").data("id");

                $.ajax({
                    url: "//www.devmedia.com.br/view/scripts/valida.php",
                    method: "POST",
                    data: { "funcao": "concluidoAlt", "comp": id,},
                    success: function(response){
                        if(response.status){
                            exibirMarcarConcluido(true);
                        }else{
                            console.log(response.html);
                        }
                    },
                    error: function(response){
                        console.log(response, true);
                    }
                });
            }
        }, false);
    }

    if(typeof player != "undefined" && player != null){
        player.video.addEventListener("videoUpdateProgress", function(e){
            let newScale = 100*e.value / player.videoLength;
            newScale = newScale / 100;
            if(newScale < 0) newScale = 0;
            if(newScale > 1) newScale = 1;

            $("#menu-aula .curso-aula.active .curso-aula-progresso-current").css("transform", "scaleX("+ newScale + ")");
        },false);
    }
}

function prism(){
    if($('[class^="pre_"]').length > 0)
    {
        $('[class^="pre_"]').each(function (i, block) {
            var classeLang = $(block).attr('class');
            $(block).find('code').addClass(classeLang);
        });

        $('[class^="code_"]').each(function (i, block) {
            var classeLang = $(block).attr('class');
            $(block).find('code').addClass(classeLang.replace("code_", "pre_"));
        });

        if($('[class^="pre_"]').length < $("code").length)
        {
            $('code:not([class^="pre_"])').each(function (i, block) {
                $(block).addClass("pre_js");   
            });
        }

        if($('[class^="code_"]').length < $("code").length)
        {
            $('code:not([class^="pre_"])').each(function (i, block) {
                $(block).addClass("pre_js");   
            });
        }

        Prism.highlightAll();
    }
    else
    {
        $('code').each(function (i, block) {
            $(block).addClass("pre_js");   
        });

        Prism.highlightAll();
    }
}

function trocaAula(idcomp_proximo){
    $(".conteudo-aula").html("");
    $('html, body').animate({scrollTop : 0},200);
    $(".curso-avaliacao ").css("display","none");
    $(".container-load").css("display","flex");

    var caminho = info["caminho"];
    var url_tecnologia = info["url_tecnologia"];
    var exercicio = info["exercicio"];
    var url_exercicio = info["url_exercicio"];
    
    $.ajax({
        url: '//www.devmedia.com.br/inc/view/controller/view_controller.php',
        type: 'POST',
        data: {funcao: 'retorna_aula', idcomp: idcomp_proximo, caminho: caminho, exercicio:exercicio, url_tecnologia:url_tecnologia, url_exercicio:url_exercicio},
        success:function(dados){
            if(dados.status == true){
                var novoURL = "https://www.devmedia.com.br/view/viewaula.php?idcomp="+idcomp_proximo;
                window.history.pushState(null, null, novoURL);
                $(".curso-play").remove();
                $(".curso-aula").removeClass("active");
    
                $(".curso-aula[data-idcomp='"+idcomp_proximo+"']").addClass("active");
    
                $(".curso-aula[data-idcomp='"+idcomp_proximo+"']").append(`
                    <span class="curso-play">
                        <svg class="svg-symbol play-button" id="svg-play">
                            <path id="Path_1008" class="st0" d="M10.9,10.1c0-1.4,0.9-1.8,2-1.1l10.3,7.1c0.8,0.4,1.1,1.4,0.6,2.2c-0.1,0.3-0.4,0.5-0.6,0.6 L12.9,26c-1.1,0.8-2,0.3-2-1.1V10.1z"></path>
                        </svg>
                    </span>
                `);
                $(".curso-play").css("margin-right", "30px");
                $(".container-load").css("display","none");
                $(".curso-avaliacao ").css("display","flex");
                $(".aula-sessoes").html(dados.html);
    
                info["concluido"] = dados.lido; //se conteudo foi concluido
                info["favorito"] = dados.favorito;
                info["id_comp_aula"] = idcomp_proximo;
    
                if($(".curso-download-button").hasClass("menu-btn-download")){
                    $(".menu-btn-download").attr("data-id",info["id_comp_aula"]);
                }
    
                $(".menu-btn-concluido").attr("data-id",info["id_comp_aula"]);
                
                if(info["concluido"] == true){
                    $(".menu-acoes-btn.menu-btn-concluido").addClass("active");
                } else {
                    $(".menu-acoes-btn.menu-btn-concluido").removeClass("active");
                }
    
                if(info["favorito"] == true){
                    $(".menu-acoes-btn.menu-btn-favoritar").addClass("active");
                } else {
                    $(".menu-acoes-btn.menu-btn-favoritar").removeClass("active");
                }
    
                $(".anotacao-area").attr("data-comp",info["id_comp_aula"]);
                $(".comentario_novo_area .comentario_input .txt_perguntar").data("idcomp",info["id_comp_aula"]);
                $("#div_comentarios").attr("data-idcomp",info["id_comp_aula"]);
                $(".menu-btn-anotacao").attr("data-id",info["id_comp_aula"]);
                $(".menu-btn-concluido").data("ultima",dados.ultimo)
                
                if(typeof dados.anotacao !== "undefined" ){
                    $(".anotacao-area, .menu-btn-anotacao").addClass("active");
                    $(".anotacao-text").val(dados.anotacao);
                }else{
                    $(".anotacao-area, .menu-btn-anotacao").removeClass("active");
                    $(".anotacao-text").val("");
                }

                $(".comentario_novo_area").css("display", "flex");
                    $(".admin-area .box-servico-admin .link-admin").each(function(index) {
                        var url = $(this).attr('href');
                        var troca_idcomp_url = url.split("=");

                        $(this).attr('href', troca_idcomp_url[0]+"="+idcomp_proximo);
                    });

                var autoMarcado = false;
                currentVideo(autoMarcado);
                prism();
                iniciarDevslider();
            } else {
                console.log(dados.html);
            }
        }
    })	
}